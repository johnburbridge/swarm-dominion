name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GODOT_VERSION: "4.6.0"
  GUT_VERSION: "9.5.0"

jobs:
  lint:
    name: GDScript Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Check GDScript format
        run: gdformat --check scripts/

      - name: Run GDScript linter
        run: gdlint scripts/

  test:
    name: GUT Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}

      - name: Download GUT addon
        run: |
          mkdir -p addons
          wget -q "https://github.com/bitwes/Gut/archive/refs/tags/v${GUT_VERSION}.tar.gz" -O gut.tar.gz
          tar -xzf gut.tar.gz
          cp -r "Gut-${GUT_VERSION}/addons/gut" addons/gut
          rm -rf gut.tar.gz "Gut-${GUT_VERSION}"

      - name: Import Godot project
        run: godot --headless --import --quit || true

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run GUT tests
        run: >
          godot --headless
          -s addons/gut/gut_cmdln.gd
          -gdir=res://tests
          -ginclude_subdirs
          -gexit
          -gjunit_xml_file=reports/results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: reports/results.xml
